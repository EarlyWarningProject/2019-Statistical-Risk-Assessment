---
title: "Makedata"
author: "Julia Levine"
date: "June 15, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE)
library(dplyr)
library(readxl)
library(data.table)
library(ggplot2)
```

#Notes

##Acronyms 

- PITF: Political Instability Task Force
- SFTG: State Failure Task Force
- COW: correlates of war

##Datasets

- [VDEM](https://www.v-dem.net/en/data/data-version-9/): needs to be updated annually. country ID are integer values 3-373; also has COW codes
- Polity: Data from Monty needs to be updated annually.
- EWP: doesn't need to be updated
- [WDI](https://datacatalog.worldbank.org/dataset/world-development-indicators): updated quarterly, but doesn't necessarily have data up to date. has "iso2c" variable
- PRIO: doesn't need to be updated, only goes up to 2008
- [UCDP](https://ucdp.uu.se/downloads/): needs to be updated annually
- [Mass Killings Data](https://earlywarningproject.ushmm.org/): Manually update new onsets from State of the World annual reports released on EWP website
- [Coup Data](https://www.jonathanmpowell.com/coup-detat-dataset.html): check for updates from Powell and Thyne


```{r}
update_years <- c(2016, 2017)
yr_of_update <- max(update_years + 1)
```


#Load data, deal with country codes

##VDEM
```{r, eval = FALSE}
# 1. Read in VDEM and deal with naming
vdem <- fread("data/2018/vdem/V-Dem-CY+Others-v8.csv")

# subset to just use these because 2019 has different variables
vdem_vars <- c("v2cldmovem_ord", "v2cldmovew_ord", "v2clkill_ord",
               "v2clsocgrp_ord", "v2clrgunev_ord", "v2csreprss_ord",
               "v2pepwrsoc_ord", "v2elrstrct", "v2psparban_ord",
               "v2psoppaut_ord", "v2jureform_ord", "v2clrelig_ord",
               "v2xcl_disc", "v2pepwrses_ord", "v2pepwrses", "e_migdpgro",
               "e_mipopula", "e_cow_exports", "e_cow_imports", "e_migdppc")
keep <- c("COWcode", "country_name", "year", vdem_vars)


# get SFTGCODE (PITF) to add to VDEM data to allow pulling in the EWP data
source("helper scripts/cowtopitf2018.R")
source("helper scripts/format_vdem.R")

# rename and create new variables
vdem <- format_vdem(dat = vdem, keep = keep)

save(vdem, file = "data/2018/vdem_keep_8_22.Rdata")
# save(vdem, file = "data/2018/vdem_keep.Rdata")

```

## EWP dataset

- No update, used for variables that don't change

```{r}
load("data/2019/EWP_final_data_31Oct2016.RData")
dat.ewp <- dat.retro.isr
rm(dat.retro.isr)


ewp_vars <- c("reg.eap", "reg.afr", "reg.eur", "reg.mna", "reg.sca",
              "mkl.start", "wdi.imrate"  ,"ios.iccpr1","elf.ethnic" , 
              "mkl.start.1", "countryage", "countryage.ln","postcw", 
              "wdi.popsize.ln" ,"pol.cat.fl1","pol.cat.fl2", "pol.cat.fl3", 
              "pol.cat.fl7","pol.durable.ln" ,"elc.eleth2","cou.tries5d", 
              "cou.f.d", "cou.s.d", "cou.a.d.1", "cou.a.d",
              "imr.normed.ln" ,"gdppcgrow.sr", "mkl.end" ,"mkl.ongoing", 
              "mkl.type","mkl.ever" )


carry <- c("reg.afr", "reg.eap", "reg.eur","reg.mna", "reg.sca", 
           "ios.iccpr1", "elf.ethnic", "countryage", 
           "mkl.ongoing", "mkl.ever")
dat.ewp$year %>% max -> carry_from
carry_ewp <- dat.ewp[dat.ewp$year == carry_from, c(carry, "sftgcode")]

keep <- c("sftgcode", "year", ewp_vars)
dat.ewp <- subset(dat.ewp, select = keep)
```

#Build up dataset


```{r}
# load("data/2018/vdem_keep.Rdata")
load("data/2018/vdem_keep_8_22.Rdata")
### Merge EWP and VDEM
dat2 <- merge(x = vdem, y = dat.ewp, by =c("sftgcode","year"), all.x=T)
rownames(dat2) <- paste0(dat2$country_name, dat2$year)
```

##Polity Data


```{r}
# Fomerly: As I understand (5 June 2018), still only available through 2016.
# Now (15 Oct 2018) --use Monty's shared data for 2017.
polity <- read_excel("data/2018/p4v2017_montyshared.xls")


# polity$scode[polity$country == "Sudan"]
polity <- polity[, c("scode", "year", "polity2", "durable")]

# investigating double Sudans
polity[polity$scode == "SUD"|polity$scode == "SDN",] %>% tail(10) 

names(polity)[names(polity)=="scode"]="sftgcode"
polity$sftgcode[polity$sftgcode=="SER"] <- "SRB"
polity$sftgcode[polity$sftgcode=="MNT"] <- "MNE"
polity$sftgcode[polity$sftgcode=="GMY"] <- "GER"
polity$sftgcode[polity$sftgcode=="SSU"] <- "SSD"
polity$sftgcode[polity$sftgcode=="SDN"] <- "SUD"
polity$sftgcode[polity$sftgcode=="USR"] <- "USS"

# keep the -4 sudan
# two Sudan 2011's. because North Sudan became Sudan, so it was double coded
badsudan=which(polity$sftgcode =="SUD" & polity$year==2011 & polity$polity2 == -2)
polity = polity[-badsudan,]

# polity[polity$sftgcode == "SUD", ] %>% tail(10)
```

```{r}
### Merge polity onto that.
dat3 <- merge(x=dat2, y=polity, by=c("sftgcode","year"), all.x=T)

#Countries that don't yet exist will have a bunch of NAs, including on reg.afr, for exmample. 
# Remove small countries that got sftgcode==0

# table(dat3$country_name[dat3$sftgcode==0])

# vdem$COWcode[vdem$country_name == "Austria"] %>% unique
# note that Austria isn't excluded, but rather, Austria-Hungary (COW-code 300)
dat3=dat3[dat3$sftgcode!=0,]
```

```{r}
#Write over the old pol.durable and pol.durable.ln with new values from polity,
# Also adding 1 to ln(durable).
dat3$pol.durable = dat3$durable
dat3$pol.durable.ln = log(1+dat3$durable)
```

```{r}
# Fearon & Laitin regime type (autocracy, anocracy, democracy)
dat3$polity2.fl=NA
dat3$polity2.fl[!is.na(dat3$polity2)]=0
dat3$polity2.fl.1=dat3$polity2.fl.2=dat3$polity2.fl.3=dat3$polity2.fl.7=dat3$polity2.fl

dat3$polity2.fl[dat3$polity2 >= -10 & dat3$polity2 < -5] <- 1  # Autocracy
dat3$polity2.fl[dat3$polity2 >= -5 & dat3$polity2 <= 5] <- 2  # Anocracy
dat3$polity2.fl[dat3$polity2 > 5] <- 3  # Democracy
#dat3$polity2.fl[dat3$polity2 == -66 | dat3$polity2 == -77 | dat3$polity2 == -88 ] <- 7  # Other
# There are no -66, -77, -88 in polity2.

dat3$polity2.fl.1[dat3$polity2.fl==1]=1
dat3$polity2.fl.2[dat3$polity2.fl==2]=1
dat3$polity2.fl.3[dat3$polity2.fl==3]=1
#dat3$polity2.fl.7[dat3$polity2.fl==7]=1

dat3$polity2_sq = dat3$polity2^2
```


##WDI (World Development Indicators)

```{r, eval = FALSE}
library(WDI)
# install.packages("WDI")
wdilist <- c("NE.TRD.GNFS.ZS",     # Trade (% of GDP)
             "NY.GDP.PCAP.PP.KD",  # GDP per capita, PPP (constant 2005 intl $)
             "NY.GDP.PCAP.KD",     # GDP per capita (constant 2000 US$)
             "NY.GDP.MKTP.KD.ZG",  # GDP growth (annual %)
             "FP.CPI.TOTL.ZG",     # Inflation, consumer prices (annual %)
            # "FP.CPI.TOTL",        # Consumer price index (2005 = 100) 
             "SP.POP.TOTL",        # Population, total
            # "SP.URB.TOTL.IN.ZS",  # Urban population (% of total)
            # "SP.POP.GROW",        # Population growth (annual %)
            # "EN.POP.DNST",        # Population density (people per sq. km of land area)
            # "SP.POP.0014.TO.ZS",  # Population ages 0-14 (% of total)
            # "MS.MIL.TOTL.P1",     # Armed forces personnel, total
            # "MS.MIL.TOTL.TF.ZS",  # Armed forces personnel (% of total labor force)
            # "NY.ADJ.DFOR.GN.ZS",  # Adjusted savings: forest depletion (% of GNI)
            # "NY.ADJ.DMIN.GN.ZS",  # Adjusted savings: mineral depletion (% of GNI)
            # "NY.ADJ.DNGY.GN.ZS",  # Adjusted savings: energy depletion (% of GNI)
            # "IT.CEL.SETS.P2",     # Mobile cellular subscriptions (per 100 people)                                        
            # "IT.NET.USER.P2",     # Internet users (per 100 people)                                              
            "SP.DYN.IMRT.IN"     # Infant mortality rate
    )

# Extract latest version of desired variables from WDI from 1945 (from web)
# from pull on 6/25/19
wdi <- WDI(country="all", indicator=wdilist, extra=FALSE, start=1945, end=yr_of_update)
apply(wdi[wdi$year == 2017, ], 2, function(x) sum(is.na(x)))

```


```{r, eval = FALSE}

# Add PITF country codes for merging (PITF uses sftg i think, seems true from the function)
source("helper scripts/f.pitfcodeit.R")
wdi <- pitfcodeit(wdi, "country")

# In summer 2018, name of Swaziland was updated to eSwatini
wdi$country <- as.character(wdi$country)
wdi$country[wdi$country=="Eswatini"] <- "Swaziland"
wdi$sftgcode[wdi$country=="Swaziland"]="SWA"

# Subset to drop cases with missing PITF codes, cut extra id vars
wdi <- subset(wdi, !is.na(sftgcode), select=-c(1, 2))
# table(unique(wdi$sftgcode))
wdi[is.na(wdi$sftgcode), "country"]

subset(wdi, is.na(sftgcode))$country %>% unique
```

- May not want to cut the "iso2c" variable if we want to switch to those country codes

```{r, eval = FALSE}
# Rename variables-- add a "new" to indicate these are newly brought in from wdi 
# to avoid reusing names already in the old EWP data
names(wdi) <- c("year",
                "wdi.trade.new",
                "wdi.gdppcppp.new",
                "wdi.gdppc.new",
                "wdi.gdppcgrow.new",
                "wdi.inflation.new",
                "wdi.popsize.new", "wdi.imrate.new", 
                "sftgcode"
                )

# Reorder for easier review
wdi <- wdi[order(wdi$sftgcode, wdi$year),]
write.csv(wdi, file = "data/2018/wdi_7-13-19.csv", row.names = FALSE)
```

```{r}
# update infant mortality rate
wdi_new <- read.csv("data/2018/wdi_7-13-19.csv")
wdi_old <- read.csv("data/2018/wdi_18Oct2018.csv")
wdi <- merge(wdi_old, wdi_new[, c("sftgcode", "year", "wdi.imrate.new")], 
             by = c("sftgcode", "year"), all.x = TRUE)
# all.equal(wdi$wdi.gdppcgrow.new, wdi_old$wdi.gdppcgrow.new)

# check for missingness
# apply(wdi[wdi$year == 2017, ], 2, function(x) sum(is.na(x)))
# wdi$sftgcode[wdi$year == 2017] %>% unique %>% length

# Merge it in:
dat4=merge(x=dat3, y=wdi, by=c("sftgcode","year"), all.x=T)

# Rename for official version, dat
dat=dat4

dat$wdi.imrate[dat$year %in% update_years] <- dat$wdi.imrate.new[dat$year %in% update_years]


# rm(dat2,dat3, dat4)
```


##PRIO battle deaths (gets us up to 2008)


```{r}
prio=read_excel("data/2018/PRIO Battle Deaths Dataset 3.1.xls")

# setdiff(prio$location, dat$country_name)
# Fix county names to match.
prio$location[prio$location=="Democratic Republic of Congo (Zaire)"] = "Democratic Republic of Congo"
prio$location[prio$location=="Congo"] = "Democratic Republic of Congo"
prio$location[prio$location=="Yugoslavia (Serbia)"] = "Serbia"

# dat$country_name[grep("Gambia", dat$country_name)] %>% unique
prio$location[prio$location=="Gambia"] = "The Gambia"
# Not sure what to do about events coded to North Yemen and South Vietnam.

#Prio type 3 and 4 are what we are concerned with - internal and "internationalized internal" conflict
prio <- filter(prio, type>=3)
```

```{r}
# some countries have multiple observations in a year...
# tab_bd <- table(bd$prio.year, bd$prio.location)
# ind <- apply(tab_bd, 2, function(x) sum(x > 1))
# ind2 <- apply(tab_bd, 2, function(x) which(x > 1))
# bd$bd[bd$prio.year %in% names(ind2$`Democratic Republic of Congo`[3]) & bd$prio.location == "Democratic Republic of Congo"]


bd <- prio$bdeadbes
i <- which(bd == -999)
bd[i] <- prio$bdeadlow[i]
bd <- data.frame(bd, prio$year, prio$location)

# group by year and country and sum battledeaths
bd <- bd %>% group_by(prio.location, prio.year) %>% summarise(battledeaths = sum(bd))

dat <- merge(dat, bd, by.x = c("country_name", "year"), 
             by.y = c("prio.location", "prio.year"), 
             all.x = TRUE, all.y = FALSE)

dat$battledeaths[is.na(dat$battledeaths)] <- 0
```


##UCDP battle-related deaths (brings us upt to date from 2008 onward)

```{r}
# Now UCDP battle-related deaths for 2008 onward
# load("../data/ucdp-brd-conf-172.RData") ## From 2016 data version
# The original xlsx seems to behave oddly; so have resaved it as CSV
#ucdp = as.data.frame(read_excel("../data/BattleRelatedDeathsDataset18.11989-01-01-2017-12-31.xlsx"))
ucdp = read.csv("data/2018/BattleRelatedDeathsDataset18.11989-01-01-2017-12-31.csv")
ucdp <- ucdp %>% filter(Year>2008 & TypeOfConflict >= 3)


setdiff(unique(ucdp$LocationInc), unique(dat$country_name))

ucdp$LocationInc = as.character(ucdp$LocationInc)

ucdp$LocationInc[ucdp$LocationInc=="Myanmar (Burma)"] = "Burma/Myanmar"
ucdp$LocationInc[ucdp$LocationInc=="Yemen (North Yemen)"] = "Yemen"
ucdp$LocationInc[ucdp$LocationInc=="DR Congo (Zaire)"] = "Democratic Republic of Congo"
ucdp$LocationInc[ucdp$LocationInc=="Russia (Soviet Union)"] = "Russia"
ucdp$LocationInc[ucdp$LocationInc=="Congo"] = "Republic of the Congo"

```



```{r}
bd <- ucdp$BdBest
bd <- data.frame(bd, ucdp$Year, ucdp$LocationInc)

bd <- bd %>% group_by(ucdp.LocationInc, ucdp.Year) %>% summarise(battledeaths = sum(bd))

dat <- merge(dat, bd, by.x = c("country_name", "year"), 
             by.y = c("ucdp.LocationInc", "ucdp.Year"), 
             all.x = TRUE, all.y = FALSE)
dat$battledeaths.y[is.na(dat$battledeaths.y)] <- 0

# adding prio deaths to ucdp deaths (prio deaths should be 0 after 2008, ucdp should be 0 before 2008)
# check
# dat$battledeaths.y[dat$year<2008] %>% sum
# dat$battledeaths.x[dat$year>2008] %>% sum

dat$battledeaths <- dat$battledeaths.x + dat$battledeaths.y
# dat$battledeaths %>% summary
dat$battledeaths.x <- NULL
dat$battledeaths.y <- NULL
dat$battledeaths.ln=log(dat$battledeaths+1)

```





##Subset

```{r}
dat=dat[dat$year>=1945,]


### Select which countries we're really using.  Mostly its the EWP countries, minus 4. 
ewpcountries = unique(dat.ewp$sftgcode)
countriestodrop = unique(dat.ewp$sftgcode[is.na(dat.ewp$mkl.start)])
# unique(dat.ewp$country_name[is.na(dat.ewp$mkl.start)])
countriestokeep = setdiff(ewpcountries, countriestodrop)
dat = dat%>%filter(sftgcode %in% countriestokeep)
```




##Carry Forward

```{r}
# merge in variables that dont change, like region, and mkl.ever. update mkl.ongoing and countryage

dat_new <- merge(dat[dat$year %in% update_years, !(colnames(dat) %in% carry)], 
                 carry_ewp, by = "sftgcode", all.x = TRUE)

# update country age
diff <- update_years - carry_from

for(i in 1:length(update_years)){
  dat_new$countryage[dat_new$year == update_years[i]] <- 
  dat_new$countryage[dat_new$year == update_years[i]] + diff[i]
}

dat_new$countryage.ln <- log(dat_new$countryage)

# check
setdiff(colnames(dat_new), colnames(dat))
setdiff(colnames(dat), colnames(dat_new))

dat_old <- dat[dat$year <= carry_from, ]
# reorder columns to prepare for rbind
dat_new <- dat_new[, colnames(dat_old)]
dat <- rbind(dat_old, dat_new)
```

##Add new onsets

###State-led

```{r}
# initialize
dat$mkl.start[dat$year %in% update_years]=0
dat$mkl.end[dat$year %in% update_years]=0
dat$mkl.start.1[dat$year %in% (update_years - 1)]=0
```


```{r}
# sftgcode, start date, end date
new_onsets <- tribble(~sftgcode, ~new_start, ~new_end, 
                       "IRQ", 2014, NA,
                       "ETH", 2015, NA,
                       "ETI", 2015, NA,
                       "PHI", 2016, NA,
                       "MYA", 2016, NA,
                       "EGY", 2013, 2014)
new_onsets[is.na(new_onsets)] <- 9999
new_onsets$new_start.1 <- new_onsets$new_start - 1
```

```{r}
dat <- merge(dat, new_onsets, by = "sftgcode", all.x= TRUE)
dat$mkl.start[dat$year == dat$new_start] <- 1
dat$mkl.start.1[dat$year == dat$new_start.1] <- 1
dat$mkl.end[dat$year == dat$new_end] <- 1
dat$mkl.ongoing[dat$year >= dat$new_start & dat$year <= dat$new_end] <- 1
dat$mkl.ongoing[dat$year > dat$new_end] <- 0

# show where we need to update mkl.ever
new_mk <- unlist(sapply(new_onsets$sftgcode, 
                 function(x) dat$mkl.ever[dat$sftgcode == x & dat$year == 2015] != 1))
names(new_mk[new_mk == TRUE])

### Update: mkl.ever -- only Egypt is new
dat$mkl.ever[dat$sftgcode=="EGY" & dat$year>=2013] = 1


# Update: mkl.type
# Not going to update as no longer in use.
dat$mkl.type[dat$year==2016] = NA
new <- which(colnames(dat) %in% c("new_end", "new_start", "new_start.1"))
dat <- subset(dat, select = -new)
```


 

###Non-state led


```{r}
#Initialize to zero
dat$nonstatemk.start=0
dat$nonstatemk.start.1=0
# table(dat$nonstatemk.start)
dat$nonstatemk.ongoing=0
dat$nonstatemk.end=0
dat$nonstatemk.ever=0
```

```{r}
newcountry=c("Liberia","India","Sierra Leone", "Algeria", "Somalia", 
             "Afghanistan", "Georgia", "Republic of the Congo","Rwanda", 
             "Democratic Republic of Congo", "Russia","Nepal", 
             "Democratic Republic of Congo", "Democratic Republic of Congo", 
             "Pakistan", "Afghanistan","Iraq", "Thailand", "India", "Somalia", 
             "Democratic Republic of Congo","Nigeria", "Syria", 
             "Central African Republic", "South Sudan")
newyear=c(1989, 1990, 1991, 1991, 1991, 
          1992, 1992, 1992, 1993, 1993, 
          1995, 1996, 1996, 1998, 2001, 
          2001, 2003, 2004, 2004, 2007, 
          2008, 2010, 2012, 2013, 2013)

#endyear, 999 for censoring
endyear = c(1990,2008,2002,2005,1992,
            1996,1993,2003,1994,1993,
            2005,2006,1997,9999,9999,
            9999,9999,9999,9999,9999,
            2012,9999,9999,9999,9999)

show <- data.frame(newcountry, newyear, endyear)
head(show)
```

```{r}
for(j in 1:length(newcountry)){
  thiscountry=newcountry[j]
  # print(thiscountry)
  thisyear=newyear[j]
  
  if (endyear[j]<= max(dat$year)) {  
    dat$nonstatemk.end[dat$country_name==thiscountry & dat$year==endyear[j]] = 1
  }
  
  thisend2=min(endyear[j], max(dat$year))  #handles censoring
  dat$nonstatemk.start[dat$country_name== thiscountry & dat$year== thisyear] = 1
  dat$nonstatemk.start.1[dat$country_name==thiscountry & dat$year==(thisyear-1)] = 1
  dat$nonstatemk.ongoing[dat$country_name==thiscountry & dat$year>=thisyear & dat$year<=thisend2] = 1
  dat$nonstatemk.ever[dat$country_name == thiscountry & dat$year>=thisyear] = 1
  
}

# look <- dat[, c("nonstatemk.start", "nonstatemk.ongoing", "nonstatemk.ever", "sftgcode", "year")]
# table(dat$nonstatemk.start, dat$mkl.start)
# table(dat$nonstatemk.ongoing)
# table(dat$nonstatemk.ever)
```


###Combined onset variable

```{r}
dat$anymk.start=0
dat$anymk.start[dat$mkl.start==1]=1
dat$anymk.start[dat$nonstatemk.start==1]=1
# table(dat$mkl.start)
# table(dat$anymk.start) # adds 16 onsets.

dat$anymk.start.1=0
dat$anymk.start.1[dat$mkl.start.1==1]=1
dat$anymk.start.1[dat$nonstatemk.start.1==1]=1
# table(dat$mkl.start.1)
# table(dat$anymk.start.1) # adds 16 predictable onsets too.

dat$anymk.ongoing=0
dat$anymk.ongoing[dat$mkl.ongoing==1]=1
dat$anymk.ongoing[dat$nonstatemk.ongoing==1]=1
# table(dat$mkl.ongoing)
# table(dat$anymk.ongoing) # adds 63 country years of ongoing

dat$anymk.ever=0
dat$anymk.ever[dat$mkl.ever==1]=1
dat$anymk.ever[dat$nonstatemk.ever==1]=1
# table(dat$mkl.ever)
# table(dat$anymk.ever) 
```


```{r}

uniquecountries <- unique(dat$sftgcode)
last_year <- sapply(uniquecountries, function(x) max(dat$year[dat$sftgcode == x]))
max_year <- data.frame(uniquecountries, last_year)

dat <- merge(dat, max_year, by.x = "sftgcode", 
             by.y = "uniquecountries", all.x = TRUE)


end <- unique(dat[dat$last_year != max(update_years), 
                  c("country_name", "last_year", "sftgcode")])


new_sftg <- sapply(end$country_name, function(x) 
  dat$sftgcode[dat$country_name == x & dat$year  == max(update_years)])

new_sftg <- lapply(new_sftg, as.character)

end$new_sftg <- new_sftg
end$new_sftg[4] <- "GER"
end$new_sftg[7] <- "VIE"
end$new_sftg[11] <- "YEM"
colnames(end) <- c("country", "last_year", "old_sftg", "new_sftg")
```

```{r}
mk_lookup <- dat[dat$anymk.start.1 == 1, c("year", "sftgcode", "anymk.start.1")]
mk_lookup$start.2 <- mk_lookup$year - 1
mk_lookup$start.3 <- mk_lookup$year - 2
mk_lookup$anymk.start.2 <- 1
mk_lookup$anymk.start.3 <- 1

dup <- mk_lookup[mk_lookup$sftgcode %in% end$new_sftg, ]
dup <- merge(dup, end[, c("old_sftg", "new_sftg")], by.x = "sftgcode", 
             by.y = "new_sftg", all.x = TRUE)
dup$sftgcode <- dup$old_sftg
dup$old_sftg <- NULL

mk_lookup <- rbind(mk_lookup, dup)

dat <- merge(dat, mk_lookup[, c("anymk.start.2", "sftgcode", "start.2")], 
             by.x = c("year", "sftgcode"), by.y = c("start.2", "sftgcode"), 
             all.x = TRUE)

dat <- merge(dat, mk_lookup[, c("anymk.start.3", "sftgcode", "start.3")], 
             by.x = c("year", "sftgcode"), by.y = c("start.3", "sftgcode"), 
             all.x = TRUE)

dat$anymk.start.2[is.na(dat$anymk.start.2)] <- 0
dat$anymk.start.3[is.na(dat$anymk.start.3)] <- 0
```


```{r}

dat$anymk.start.1[dat$year>=yr_of_update - 1] = NA
dat$anymk.start.2[dat$year>=yr_of_update - 2] = NA
dat$anymk.start.3[dat$year>=yr_of_update - 3] = NA
```






```{r}

dat = dat %>% mutate(anymk.start.2window = as.numeric(anymk.start.1 | anymk.start.2),
                     anymk.start.3window = as.numeric(anymk.start.1 | anymk.start.2 | anymk.start.3))

# table(dat$anymk.start.2, dat$year)
# table(dat$anymk.start.3, dat$year)

# Make these windows also NA where there is not enough time left
# to code the whole window
dat$anymk.start.2window[dat$year>=(yr_of_update - 2)] = NA
dat$anymk.start.3window[dat$year>=(yr_of_update - 3)] = NA


dat=as.data.frame(dat)
# table(dat$country_name[dat$year==2017])
#View(dat[dat$country_name=="Sudan",c("year", "country_name","anymk.start.2","anymk.start.2window","anymk.start.1", "anymk.start")])
```



###Coup Attempts

```{r}

coup_dat <- read.delim("http://www.uky.edu/~clthyn2/coup_data/powell_thyne_coups_final.txt")
new_coup <- coup_dat[coup_dat$year %in% update_years, ]
# new_coup <- coup_dat[coup_dat$year %in% c(2016:2019), ]
new_coup$coup <- factor(new_coup$coup)
```




```{r}
# set to 0 for years to be updated
dat$cou.s.d[dat$year %in% update_years]=0
dat$cou.f.d[dat$year %in% update_years]=0


# table(new_coup$coup)
# dat2$country_name %>% class
# new_coup$country %>% class
for(i in 1:nrow(new_coup)){
  if(new_coup$coup[i] == 2){#successful coup
    dat$cou.s.d[dat$year == new_coup$year[i] & 
                   as.character(dat$country_name) == as.character(new_coup$country[i])] = 1
    dat$cou.f.d[dat$year == new_coup$year[i] & 
                   as.character(dat$country_name) == as.character(new_coup$country[i])] = 0
  }
  if(new_coup$coup[i] == 1){#failed coup
     dat$cou.s.d[dat$year == new_coup$year[i] & 
                    as.character(dat$country_name) == as.character(new_coup$country[i])] = 0
     dat$cou.f.d[dat$year == new_coup$year[i] & 
                    as.character(dat$country_name) == as.character(new_coup$country[i])] = 1
  }
}

```

```{r}
dat$cou.any = ifelse(dat$cou.s.d>0 | dat$cou.f.d>0, 1, 0)

# table(dat$cou.any)
# manually update for three countries:

dat$cou.any[dat$sftgcode == "GAB" & dat$year == 1964] <- 1
dat$cou.any[dat$sftgcode == "DJI" & dat$year == 2000] <- 1
# dat$cou.any[dat$sftgcode == "ETI" & dat$year == 1993] <- 1

```


```{r}
# Construct indicator for coup attempt in prior five years.
# Construct separately from cou.tries5d
dat$coup.try.5yr <- 0
cou_countries <- unique(na.omit(dat$sftgcode[dat$cou.any == 1]))

for(i in 1:length(cou_countries)){
  ind <- na.omit(dat$year[dat$sftgcode == cou_countries[i] & dat$cou.any == 1])
  end <- ind + 4
  seq <- as.vector(sapply(1:length(ind), function(x) ind[x]:end[x]) )
  seq <- unique(seq)
  dat$coup.try.5yr[dat$sftgcode == cou_countries[i] & dat$year %in% seq] <- 1
}

```


```{r}
# Eritrea was formed from Ethiopia in 1993 after a 1989 coup. It inherits the 5 year lag in 1993
dat$coup.try.5yr[dat$sftgcode == "ETI" & dat$year == 1993] <- 1
```


#Data Preparation


```{r}
# Instead of postcw we'll want to know if we're on 1989 or after since the definition
# of the outcome will include non-state MK
dat$includesnonstate=0
dat$includesnonstate[dat$year>=1989]=1

```


##Remake some variables

```{r}
# Remake countryage.ln
dat$countryage.ln=log(dat$countryage+1)

# Remake pol.durable.ln
dat$pol.durable.ln=log(dat$pol.durable+1)
dat$durable.ln = dat$pol.durable.ln  # for no good reason, we have this with a different name.

dat=as.data.frame(dat)  #get rid of tidyverse classing which causes problems. 

# Infant mortality: previously used VDEM version, e_peinfmor.
# However WDI is the same where both are present, and has less missingness. 

# should we be treating this as time invariant??
dat$imr.sqrt = sqrt(dat$wdi.imrate)
sum(is.na(dat$wdi.imrate[dat$year %in% c(2015:2017)]))
```

```{r}
dat$tradeshare.ln=log(dat$tradeshare)  # has reasonable distribution actually.
# plot(density(dat$tradeshare.ln, na.rm=TRUE), ylim=c(0,1), xlim=c(-10,10))

dat$wdi.trade.ln.new = log(dat$wdi.trade.new)
#lines(density(dat$wdi.trade.ln.new, na.rm=TRUE))
# cor(dat$tradeshare.ln, dat$wdi.trade.ln.new, use="complete.obs")

#Unfortunately a lot of missingness. Let's look, and compare to wdi.trade.new
# View(dat[,c("country_name","sftgcode","year","wdi.trade.ln.new","tradeshare.ln")])

# Make an adjusted version of the wdi one to fit the tradeshare (VDEM) one:
lm.adjust.trade = lm(tradeshare.ln~wdi.trade.ln.new, data=dat)

dat$wdi.trade.ln.new.adj=lm.adjust.trade$coefficients[1] + lm.adjust.trade$coefficients[2]*dat$wdi.trade.ln.new

#Where tradeshare is missing, replace with the adjusted wdi.trade.ln.new
dat$tradeshare.ln.combined = dat$tradeshare.ln
dat$tradeshare.ln.combined[is.na(dat$tradeshare.ln)]=dat$wdi.trade.ln.new.adj[is.na(dat$tradeshare.ln)]
sum(is.na(dat$tradeshare.ln))
sum(is.na(dat$tradeshare.ln.combined)) #Cuts missingness a good bit
```

```{r}
# Some missingness on popsize.ln -- let's take a look and again consider filling in with WDI. 
#View(dat[,c("country_name","sftgcode","year","wdi.popsize.new","popsize")])

# Similarly, popsize is missing from both VDEM and WDI.

# Make and adjusted version of the wdi one to fit the tradeshare (VDEM) one:
lm.adjust.popsize = lm(popsize~wdi.popsize.new, data=dat)
dat$wdi.popsize.new.adj=lm.adjust.popsize$coefficients[1] + lm.adjust.popsize$coefficients[2]*dat$wdi.popsize.new

#Where popsize is missing, replace with the adjusted wdi.trade.ln.new
dat$popsize.combined = dat$popsize
dat$popsize.combined[is.na(dat$popsize)]=dat$wdi.popsize.new.adj[is.na(dat$popsize)]
sum(is.na(dat$popsize))
sum(is.na(dat$popsize.combined)) #Cuts most of missingness

dat$popsize.ln.combined = log(dat$popsize.combined)
```
```{r}
# First, we are only looking at countries over .5 million in pop
# (Changed from 1 million, 25 May 2018)

dat$country_name[is.na(dat$popsize.combined) & dat$year==2016]
### We need population data for Eritrea, North Korea

### For now, let those with population = NA thgrough. 
dat = filter(dat, popsize.combined>.5e6 | is.na(popsize.combined))
#  dat %>% filter(country_name %in% checkcountries, year>=2011) %>% select(country_name, year, popsize.combined) %>% View()

```





```{r}
# And gdpgrowth is problematic too:
#View(dat[,c("country_name","sftgcode","year","wdi.gdppcgrow.new","gdppcgrowth")])

# The gdp growth figures from VDEM and WDI aren't as correlated as you'd like, but
# again WDI is missing before 1960 while the VDEM ones typically stop early.
with(dat, cor(wdi.gdppcgrow.new, gdppcgrowth, use="complete.obs"))
# Make and adjusted version of the wdi one to fit the tradeshare (VDEM) one:
lm.adjust.gdppcgrowth = lm(gdppcgrowth~wdi.gdppcgrow.new, data=dat)

dat$wdi.gdppcgrow.new.adj=lm.adjust.gdppcgrowth$coefficients[1] + lm.adjust.gdppcgrowth$coefficients[2]*dat$wdi.gdppcgrow.new

#Where gdp missing from vdem, replace with WDI.
dat$gdppcgrowth.combined = dat$gdppcgrowth
dat$gdppcgrowth.combined[is.na(dat$gdppcgrowth)]=dat$wdi.gdppcgrow.new.adj[is.na(dat$gdppcgrowth)]
sum(is.na(dat$gdppcgrowth))
sum(is.na(dat$gdppcgrowth.combined)) #Cuts most of missingness
```



```{r}

predictornames <- c("anymk.ongoing","anymk.ever",
                    "reg.afr", "reg.eap", "reg.eur", "reg.mna", "reg.sca", #americas, "reg.amr" left out as baseline.
                    "countryage.ln", "popsize.ln.combined", "imr.sqrt", "gdppcgrowth.combined",
                    "ios.iccpr1","includesnonstate",
                    "durable.ln","minorityrule", "elf.ethnic", "battledeaths.ln",
                    "candidaterestriction", "partyban","judicialreform",
                    "religiousfreedom", "pol_killing_approved",
                    "freemove_men4","freemove_women4", "freediscussion",
                    "social_inequality","even_civilrights","repress_civilsoc",
                    "social_power_dist", "ses_power_dist", 
                    "tradeshare.ln.combined", 
                    "coup.try.5yr",
                    "polity2.fl.2","polity2.fl.3")

```



#Missingness

```{r}

dat.check = dat[dat$year %in% update_years, c("country_name","year", predictornames)]

comp <- lapply(update_years, function(y) apply(dat.check[dat.check$year == y,], 2, function(x) sum(is.na(x))))
na.count <- unlist(comp)
years <- rep(update_years, each = ncol(dat.check))
check <- data.frame(na.count, years, names(na.count))

check <- check[check$na.count > 0 & !(check$names.na.count. %in% c("anymk.start.1", "mkl.start.1")), ]

missing1 <- ggplot(check) + 
  geom_bar(aes(y = na.count, x = names.na.count., fill = factor(years)), stat = "identity")+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = "Missing Variables", y = "Number of Observations Missing", fill = "Year")

missing1
# Tradeshare.ln.combined is still the biggest trouble maker.
```




##Fix missingness

 - Fix missingness in 2016 and 2017
 - Idea is that we can't fix all missingness, but at least want to fill in where we are making predictions from.


```{r}
# function to look at patterns in NAs over time for each country with missing values
library(purrr)
look_na <- function(variable){
  missing <- dat[is.na(dat[, variable]) & dat$year %in% update_years, c("year", "country_name")]
  countries <- unique(missing$country_name)
  look <-lapply(1:length(countries), function(x) dat[dat$country_name == countries[x], c("year", variable)])
  
  look <- reduce(look,full_join, by = "year")
  colnames(look) <- c("year", as.character(countries))
  look <- look[order(look$year, decreasing = TRUE), ]
  look
}
```


###candidate restriction



```{r}
look_candidaterestriction <- look_na("candidaterestriction")
head(look_candidaterestriction, 10)

# Candidaterestriction missing from two
dat$candidaterestriction[dat$year==2017 & dat$country_name=="Timor-Leste"] = 
  dat$candidaterestriction[dat$year==2016 & dat$country_name=="Timor-Leste"]

dat$candidaterestriction[dat$year==2017 & dat$country_name=="Sudan"] = 
  dat$candidaterestriction[dat$year==2016 & dat$country_name=="Sudan"]

# Bahrain was missing Candidaterestriction 2013-2016.  Was 1 before that and 0 after. 
# For 2016 I will go with the 2017 value, 0.
dat$candidaterestriction[dat$year==2016 & dat$country_name=="Bahrain"] =0

#UAE is missing candidaterestriction in 2013-2016 but is otherwise "1".
dat$candidaterestriction[dat$year>=2001 & dat$country_name=="United Arab Emirates"]=1
```


###elf.ethnic

```{r}
look_elf.ethnic <- look_na("elf.ethnic")
head(look_elf.ethnic, 10)

#Timor-leste missing elf.ethnic in both years.  
# Haven't found a good source elsewhere.  The largest ethnic group 
# I can find evidence of is 100,000, out of a population of about 1 million
# That bounds the ELF to be above 0.9.  So I'll take that. 
dat[dat$country_name=="Timor-Leste", "elf.ethnic" ] = .9

# Serbia missing elf.ethnic in both. Missing for all of time actually. 
# Fearon does not give, but Alesina gives a 0.57 on "ethnic fractionalization", so let's go with that.
dat[dat$country_name == "Serbia", "elf.ethnic"] = 0.57

# Montenegro -- just missing ELF; see note at top for approximation
dat[dat$country_name=="Montenegro", "elf.ethnic"] = 0.70

# ELF is missing permanently for South Sudan and Yemen.  See notes at top
# for approximations added here. 
dat[dat$country_name=="South Sudan","elf.ethnic"] = 0.73
dat[dat$country_name=="Yemen","elf.ethnic"] = 0.135

```


###gdp pc growth combined

```{r}
look_gdppcgrowth <- look_na("gdppcgrowth.combined")
head(look_gdppcgrowth, 10)

#Cuba  — missing gdppcgrowth in 2016 and 2017, present in 2015. 
#dat[dat$country_name=="Cuba" & dat$year==2015, "gdppcgrowth.combined"]
# CIA factbook says -0.9% in 2016. Take that, carry it for 2017. 
dat[dat$country_name=="Cuba" & (dat$year==2016 | dat$year==2017), "gdppcgrowth.combined"]= -0.009

# gdppcgrowth.ln.combined, using CIA Factbook, which just gives flat estimates in 2015-2017
dat[dat$country_name=="Eritrea" & dat$year==2016, "gdppcgrowth.combined"] = 0
dat[dat$country_name=="Eritrea" & dat$year==2017, "gdppcgrowth.combined"] = 0

# gdppcgrowth.combined -- not available from factbook. So carrying forward. 
dat[dat$country_name=="North Korea" & (dat$year==2017 | dat$year==2016), "gdppcgrowth.combined"] = 
dat[dat$country_name=="North Korea" & dat$year==2015, "gdppcgrowth.combined"]

#Somalia — missing gdppcgrowth since at least 2012
# no per capita estimates available; using gdp growth rate (i.e. assuming roughly
# stable population)
dat[dat$country_name=="Somalia" & dat$year==2016, "gdppcgrowth.combined"] = 0.032
dat[dat$country_name=="Somalia" & dat$year==2017, "gdppcgrowth.combined"] = 0.024


# South Sudan also missing gdppcgrowth in 2017. CIA factbook shows contradiction
  # between growth rate (in overall real GDP) and the change in GDPpc. 
  # Going with the more conservative value. 
dat[dat$country_name=="South Sudan" & dat$year==2017, "gdppcgrowth.combined"]= -.0065

#gdppcgrowth data from 2014 vs. 2015 is last available. 
#I will assume continued deterioration at that rate. 
dat[dat$country_name=="Syria" & dat$year==2016, "gdppcgrowth.combined"] = (2900-3300)/2900
dat[dat$country_name=="Syria" & dat$year==2017, "gdppcgrowth.combined"] = (2900-3300)/2900

# fill in gdppcgrowth from CIA factbook
dat[dat$country_name=="Venezuela" & dat$year==2016, "gdppcgrowth.combined"] = (14300-17300)/17300
dat[dat$country_name=="Venezuela" & dat$year==2017, "gdppcgrowth.combined"] = (12400-14300)/14300


#Yemen missing Gdppcgrowth in 2017. CIA factbook:
dat[dat$country_name=="Yemen" & dat$year==2017, "gdppcgrowth.combined"]= (2300-2400)/2400


# Macedonia missing in 2017. CIA Factbook: 
dat[dat$country_name == "Macedonia" & dat$year == 2017, "gdppcgrowth.combined"] <- (14900 - 15000)/15000




# these aren't missing??

#Djibouti missing gdppcgrowth.combined in 2016 and 2017. 
# CIA factbook has estimates for both. 
#, present in 2015;  

# dat[dat$country_name=="Djibouti" & dat$year==2016, 
#     "gdppcgrowth.combined"]= 0.065
# dat[dat$country_name=="Djibouti" & dat$year==2017, 
#     "gdppcgrowth.combined"]= 0.07

  
#Oman missing Gdppcgrowth in 2017. CIA factbook says 0.

# dat[dat$country_name=="Oman" & dat$year==2017, "gdppcgrowth.combined"]= 0
```


###imr.sqrt

```{r}
look_imr.sqrt <- look_na("imr.sqrt")
head(look_imr.sqrt, 10)

### North Korea is missing infant mortality in all years.  Factbook puts it at
# 21.4 deaths/1,000. Use that in all years

dat[dat$country_name=="North Korea","imr.sqrt"]=  sqrt(22)

# CIA Factbook for North Macedonia: 7.8 deaths/1,000 live births 
dat[dat$country_name=="Macedonia" & dat$year %in% update_years,"imr.sqrt"]=  sqrt(7.8)
```


###polity2

```{r}

look_polity2 <- look_na("polity2")
head(look_polity2, 30)

#Bosnia and Herzegovina missing polity in both years - last available showed
# polity2.fl.2 = 1 in 1992-1994.  Let's keep it there (throughout all years), but make note. 
# Oct 15: NOTE THAT THIS IS STILL MISSING Polity in Monty's shared 2017 polity data.
dat[dat$country_name=="Bosnia and Herzegovina", c("polity2.fl.2")] = 1
dat[dat$country_name=="Bosnia and Herzegovina", c("polity2.fl.3") ] = 0
dat[dat$country_name=="Bosnia and Herzegovina", c("polity2.fl.2") ] = 0

#Haiti missing polity in 2016 and 2017
# Now filled in with updated polity data.
#dat[dat$country_name=="Haiti" & (dat$year==2016 | dat$year==2017), "polity2.fl.2"] = 1  # Value in 2015
#dat[dat$country_name=="Haiti" & (dat$year==2016 | dat$year==2017), "polity2.fl.1"] = 0
#dat[dat$country_name=="Haiti" & (dat$year==2016 | dat$year==2017), "polity2.fl.3"] = 0
```


###popsize.ln.combined

```{r}
look_popsize <- look_na("popsize.ln.combined")
head(look_popsize, 10)

# Eritrea
# population, from CIA factbook, for 2017 actually, used in both 2016 and 2017.
dat[dat$country_name=="Eritrea" & (dat$year==2016 | dat$year==2017), "popsize.combined"] = 5.92e6
dat[dat$country_name=="Eritrea" & (dat$year==2016 | dat$year==2017), "popsize.ln.combined"] = log(5.92e6)

# North Korea 
# population, from UNDESA
dat[dat$country_name=="North Korea" & (dat$year==2016 | dat$year==2017), "popsize.ln.combined"] = log(25.37e6)

# macedonia, CIA Factbook 2018 estimate: 2,118,945
# dat[dat$country_name=="Macedonia" & dat$year %in% update_years, "popsize.ln.combined"] = log(2118945)
```


###tradeshare.ln.combined

Note: I had previously noticed that the original code filled in values that were not missing, writing over values we had in the data with CIA Factbook data. I am keeping it as is for now, so I can compare to the original data. 

Note2: After meeting with CH, we decided to only fill in what was truly missing

```{r, eval = TRUE}
look_tradeshare <- look_na("tradeshare.ln.combined")
head(look_tradeshare, 10)
# Afhganistan missingness in 2017
dat[dat$country_name=="Afghanistan" & (dat$year==2017), "tradeshare.ln.combined"]=
dat[dat$country_name=="Afghanistan" & (dat$year==2016), "tradeshare.ln.combined"]

#Cuba missing tradeshare.ln.combined in 2016 and 2017, present in 2015. 
# Carry forward to both.
dat[dat$country_name=="Cuba" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"]= 
  dat[dat$country_name=="Cuba" & dat$year==2015, "tradeshare.ln.combined"]

# Eritrea
dat[dat$country_name=="Eritrea" & dat$year==2016, "tradeshare.ln.combined"] = 
  log((485 + 1049 )/6050)

dat[dat$country_name=="Eritrea" & dat$year==2017, "tradeshare.ln.combined"] = 
  log((636 + 1127 )/6050)


#Timor-Leste missing tradeshare in 2017 (no longer missing in 2016 though!)
dat[dat$country_name=="Timor-Leste" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="Timor-Leste" & dat$year==2016, "tradeshare.ln.combined"]

#Libya — missing in 2016 and 2017 but now available up to 2015.
dat[dat$country_name=="Libya" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  dat[dat$country_name=="Libya" & (dat$year==2015), "tradeshare.ln.combined"] 

#Nigeria missing tradeshare in 2017, but now available in 2016.
dat[dat$country_name=="Nigeria" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="Nigeria" & dat$year==2016, "tradeshare.ln.combined"]
  
#PNG — missing tradeshare since at least 2005 now (used to be available later).
# Fill in up to 2015 from the 2005 value
# Then fill in 2016 and 2017 from CIA factbook based estimates.
dat[dat$country_name=="Papua New Guinea" & dat$year>=2006, "tradeshare.ln.combined"] =
  dat[dat$country_name=="Papua New Guinea" & dat$year==2005, "tradeshare.ln.combined"] 

dat[dat$country_name=="Papua New Guinea" & dat$year==2016, "tradeshare.ln.combined"] = 
  log((9.22 + 2.27)/29.92)
dat[dat$country_name=="Papua New Guinea" & dat$year==2017, "tradeshare.ln.combined"] = log((9.52 + 1.88)/21.8)


  
# North korea tradeshare.ln.combined -- can get for 2015 and 2016 from factbook. Carry forward for 2017.
# (except that denominator comes from 2013 only!)

dat[dat$country_name=="North Korea" & dat$year==2016, "tradeshare.ln.combined"] = log((3.75+2.99)/28)

dat[dat$country_name=="North Korea" & dat$year==2015, "tradeshare.ln.combined"] = log((3.71+2.91)/28)

dat[dat$country_name=="North Korea" & dat$year==2017, "tradeshare.ln.combined"] = 
  dat[dat$country_name=="North Korea" & dat$year==2016, "tradeshare.ln.combined"]




# Solomon Islands -- needs tradeshare.ln.combined
# Using CIA factbook data but appears to be buggy -- import and export numbers the same,
# and lists 2015 twice rather than 2016 and 2015 (for both, with identical numbers.)
dat[dat$country_name=="Solomon Islands" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((.4199 + .4199 )/1.273)

# South Sudan missing tradeshare in 2017 but not available in 2016.

dat[dat$country_name=="South Sudan" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="South Sudan" & dat$year==2016, "tradeshare.ln.combined"]


#Syria — missing both gdppcgrowth and tradeshare since at least 2012
dat[dat$country_name=="Syria" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((1.71 + 5.50)/24.6)


#Turkmenistan — missing tradeshare since 2013
dat[dat$country_name=="Turkmenistan" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((6.99 + 5.00)/41.67)

# Trinidad and Tobago missing tradeshare in 2016 and 2017.
dat[dat$country_name=="Trinidad and Tobago" & (dat$year==2016), "tradeshare.ln.combined"]= 
  log((8.71+9.49)/20.3)
dat[dat$country_name=="Trinidad and Tobago" & (dat$year==2017), "tradeshare.ln.combined"]= 
  log((10.2+9.67)/20.3)


#Venezuela — missing gdppcgrowth and tradeshare in 2015, 2016, but both present in 2014.
dat[dat$country_name=="Venezuela" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((27.2 + 20.19)/215.3)


# macedonia CIA Factbook: exports $4.601 billion (2017 est.)$3.75 billion (2016 est.)
# imports: $6.63 billion (2017 est.) $5.805 billion (2016 est.)
# gdp: $31.03 billion (2017 est.) $31.02 billion (2016 est.)

dat[dat$country_name == "Macedonia" & dat$year == 2016, "tradeshare.ln.combined"] <- 
  log((3.75 + 5.805)/31.02)
dat[dat$country_name == "Macedonia" & dat$year == 2017, "tradeshare.ln.combined"] <- 
  log((4.601 + 6.63)/31.03)

# yemen, CIA Factbook
# gdp: $73.63 billion (2017 est.) , $78.28 billion (2016 est.)
# exports: $384.5 million (2017 est.) , $940 million (2016 est.)
# imports: $4.079 billion (2017 est.) , $3.117 billion (2016 est.)

dat[dat$country_name == "Yemen" & dat$year == 2016, "tradeshare.ln.combined"] <- 
  log((3.117 + .940)/78.28 )
dat[dat$country_name == "Yemen" & dat$year == 2017, "tradeshare.ln.combined"] <- 
  log((4.079 + .3845)/73.63 )

# fiji, CIA Factbook
# gdp: $8.629 billion (2017 est.) , $8.376 billion (2016 est.)
# imports: $1.911 billion (2017 est.) , $1.761 billion (2016 est.)
# exports: $908.2 million (2017 est.) $709 million (2016 est.)
dat[dat$country_name == "Fiji" & dat$year == 2016, "tradeshare.ln.combined"] <- 
  log((1.761 + 0.709)/8.376)
dat[dat$country_name == "Fiji" & dat$year == 2017, "tradeshare.ln.combined"] <- 
  log((1.911 + .9082)/8.629)
```


```{r, eval=FALSE}
# not missing?

#Burkina Faso missing tradeshare.ln.combined in 2016 and 2017, present in 2015
#Carry forward to both.
dat[dat$country_name=="Burkina Faso" & (dat$year==2016 | dat$year==2017), 
    "tradeshare.ln.combined"]= 
dat[dat$country_name=="Burkina Faso" & dat$year==2015, "tradeshare.ln.combined"]

#Jordan missing tradeshare since 2010. But stable enough before then
# so let's carry forward.
dat[dat$country_name=="Jordan" & dat$year>=2010, "tradeshare.ln.combined"] = 
dat[dat$country_name=="Jordan" & dat$year==2009, "tradeshare.ln.combined"] 

### NOTES: Taiwan missing tradeshare all years. But it is missing a lot, because
### not in some datasets. So let Taiwan be missing.
```


```{r, eval = FALSE}
# Afhganistan missingness in 2017
dat[dat$country_name=="Afghanistan" & (dat$year==2017), "tradeshare.ln.combined"]=
dat[dat$country_name=="Afghanistan" & (dat$year==2016), "tradeshare.ln.combined"]

#Cuba missing tradeshare.ln.combined in 2016 and 2017, present in 2015. 
# Carry forward to both.
dat[dat$country_name=="Cuba" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"]= 
  dat[dat$country_name=="Cuba" & dat$year==2015, "tradeshare.ln.combined"]

#Burkina Faso missing tradeshare.ln.combined in 2016 and 2017, present in 2015
#Carry forward to both.
dat[dat$country_name=="Burkina Faso" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"]= 
dat[dat$country_name=="Burkina Faso" & dat$year==2015, "tradeshare.ln.combined"]


#Timor-Leste missing tradeshare in 2017 (no longer missing in 2016 though!)
dat[dat$country_name=="Timor-Leste" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="Timor-Leste" & dat$year==2016, "tradeshare.ln.combined"]


#Jordan missing tradeshare since 2010. But stable enough before then
# so let's carry forward.
dat[dat$country_name=="Jordan" & dat$year>=2010, "tradeshare.ln.combined"] = 
dat[dat$country_name=="Jordan" & dat$year==2009, "tradeshare.ln.combined"] 

#Nigeria missing tradeshare in 2017, but now available in 2016.
dat[dat$country_name=="Nigeria" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="Nigeria" & dat$year==2016, "tradeshare.ln.combined"]

# South Sudan missing tradeshare in 2017 but not available in 2016.

dat[dat$country_name=="South Sudan" & dat$year==2017, "tradeshare.ln.combined"]= 
dat[dat$country_name=="South Sudan" & dat$year==2016, "tradeshare.ln.combined"]

# Trinidad and Tobago missing tradeshare in 2016 and 2017.
dat[dat$country_name=="Trinidad and Tobago" & (dat$year==2016), "tradeshare.ln.combined"]= 
  log((8.71+9.49)/20.3)

dat[dat$country_name=="Trinidad and Tobago" & (dat$year==2017), "tradeshare.ln.combined"]= 
  log((10.2+9.67)/20.3)


#Libya — missing in 2016 and 2017 but now available up to 2015.
dat[dat$country_name=="Libya" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  dat[dat$country_name=="Libya" & (dat$year==2015), "tradeshare.ln.combined"] 
  
  
#PNG — missing tradeshare since at least 2005 now (used to be available later).
# Fill in up to 2015 from the 2005 value
# Then fill in 2016 and 2017 from CIA factbook based estimates.
dat[dat$country_name=="Papua New Guinea" & dat$year>=2006, "tradeshare.ln.combined"] =
  dat[dat$country_name=="Papua New Guinea" & dat$year==2005, "tradeshare.ln.combined"] 

dat[dat$country_name=="Papua New Guinea" & dat$year==2016, "tradeshare.ln.combined"] = 
  log((9.22 + 2.27)/29.92)
dat[dat$country_name=="Papua New Guinea" & dat$year==2017, "tradeshare.ln.combined"] = log((9.52 + 1.88)/21.8)



#Syria — missing both gdppcgrowth and tradeshare since at least 2012
dat[dat$country_name=="Syria" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((1.71 + 5.50)/24.6)


#Turkmenistan — missing tradeshare since 2013
dat[dat$country_name=="Turkmenistan" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((6.99 + 5.00)/41.67)

#Venezuela — missing gdppcgrowth and tradeshare in 2015, 2016, but both present in 2014.
dat[dat$country_name=="Venezuela" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((27.2 + 20.19)/215.3)


# tradeshare.ln.combined -- can get for 2015 and 2016 from factbook. Carry forward for 2017.
# (except that denominator comes from 2013 only!)

dat[dat$country_name=="North Korea" & dat$year==2016, "tradeshare.ln.combined"] = log((3.75+2.99)/28)

dat[dat$country_name=="North Korea" & dat$year==2015, "tradeshare.ln.combined"] = log((3.71+2.91)/28)

dat[dat$country_name=="North Korea" & dat$year==2017, "tradeshare.ln.combined"] = 
  dat[dat$country_name=="North Korea" & dat$year==2016, "tradeshare.ln.combined"]


# Eritrea
dat[dat$country_name=="Eritrea" & dat$year==2016, "tradeshare.ln.combined"] = 
  log((485 + 1049 )/6050)

dat[dat$country_name=="Eritrea" & dat$year==2017, "tradeshare.ln.combined"] = 
  log((636 + 1127 )/6050)

  
# Solomon Islands -- needs tradeshare.ln.combined
# Using CIA factbook data but appears to be buggy -- import and export numbers the same,
# and lists 2015 twice rather than 2016 and 2015 (for both, with identical numbers.)
dat[dat$country_name=="Solomon Islands" & (dat$year==2016 | dat$year==2017), "tradeshare.ln.combined"] = 
  log((.4199 + .4199 )/1.273)
```






```{r}
dat.check = dat[dat$year %in% update_years & dat$country_name != "Taiwan", 
                c("country_name","year", predictornames)]

comp <- lapply(update_years, function(y) apply(dat.check[dat.check$year == y,], 
                                               2, function(x) sum(is.na(x))))
na.count <- unlist(comp)
years <- rep(update_years, each = ncol(dat.check))
check <- data.frame(na.count, years, names(na.count))

check <- check[check$na.count > 0 & !(check$names.na.count. %in% 
                                        c("anymk.start.1", "mkl.start.1")), ]

missing2 <- ggplot(check) + 
  geom_bar(aes(y = na.count, x = names.na.count., fill = factor(years)), 
           stat = "identity")+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = "Missing Variables", y = "Number of Observations Missing", 
       fill = "Year")

missing2
```


```{r}
# Biggest problem is missing on  tradeshare.ln.combined in 23 countries. 
# Carry forward. 
uniquecountries=unique(dat[dat$year==2017, "country_name"])



for (j in 1: length(uniquecountries)){
  thiscountry=uniquecountries[j]
  if (is.na(dat$tradeshare.ln.combined[dat$country_name==thiscountry & dat$year==2017])){
    dat$tradeshare.ln.combined[dat$country_name==thiscountry & dat$year==2017]=dat$tradeshare.ln.combined[dat$country_name==thiscountry & dat$year==2016]
  }
}
```


```{r}
dat.check = dat[dat$year %in% update_years & dat$country_name != "Taiwan", 
                c("country_name","year", predictornames)]

comp <- lapply(update_years, function(y) apply(dat.check[dat.check$year == y,], 
                                               2, function(x) sum(is.na(x))))
na.count <- unlist(comp)
years <- rep(update_years, each = ncol(dat.check))
check <- data.frame(na.count, years, names(na.count))
# there should be no variables still missing
check$names.na.count.[check$na.count>0]
```




#Save data
```{r}
#save(dat, file = "prepared2017predictors_20July2018.RData")
# getwd()


save(dat, file = "prepared2017predictors_8_22_19.RData")
# load("prepared2017predictors.RData")

```




